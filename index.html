<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admission Tracker Pro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');

        body {
            font-family: "Hind Siliguri", sans-serif;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .dark .tooltip .tooltiptext {
            background-color: #f3f4f6;
            color: #111827;
        }
    </style>


    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-500">
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl flex items-center space-x-4">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
            <span class="text-lg font-medium">Processing...</span>
        </div>
    </div>

    <header
        class="backdrop-blur-lg bg-white/80 dark:bg-gray-900/80 text-gray-900 dark:text-white shadow-lg sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">

            <!-- Branding Section -->
            <div class="flex flex-col items-center md:items-start gap-2 w-full md:w-auto">
                <!-- Logo and Title -->
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-9 w-9 text-yellow-500 dark:text-yellow-400 drop-shadow" fill="currentColor"
                        viewBox="0 0 24 24">
                        <path d="M12 2L1 7l11 5 9-4.09v6.18L12 22 3 13.18V7L12 2z" />
                    </svg>
                    <h1
                        class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-purple-500 to-pink-500 dark:from-yellow-300 dark:via-orange-400 dark:to-red-500 drop-shadow">
                        Admission Tracker Pro
                    </h1>
                </div>

                <!-- Developer Credit - Modern Compact Badge -->
                <a href="https://wa.me/+8801840643946" target="_blank"
                    class="group relative inline-flex items-center px-3 py-1.5 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 dark:from-yellow-400 dark:to-orange-500 text-white text-xs font-medium shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden">

                    <!-- Animated background effect -->
                    <span
                        class="absolute inset-0 bg-gradient-to-r from-sky-600 to-indigo-700 dark:from-yellow-500 dark:to-orange-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>

                    <!-- Content -->
                    <span class="relative z-10 flex items-center gap-1.5">
                        <span class="text-xs">üë®‚Äçüíª</span>
                        <span>Mustafa Rahman</span>
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-3 w-3 ml-0.5 opacity-70 group-hover:translate-x-0.5 group-hover:opacity-100 transition-transform"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </span>
                </a>
            </div>

            <!-- Warning Notice - Now with highlighted white background -->
            <div
                class="w-full md:max-w-md lg:max-w-xl xl:max-w-2xl bg-white dark:bg-gray-800 border-2 border-green-500 dark:border-green-400 rounded-lg p-3 shadow-lg">
                <div
                    class="flex items-center justify-center gap-2 text-green-700 dark:text-green-300 font-bold text-sm sm:text-base">
                    <span class="text-center">
                        ‡¶´‡ßã‡¶® ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶™‡ßç‡¶∞‡¶´‡ßá‡¶∂‡¶®‡¶æ‡¶≤‡¶ø‡¶ú‡¶Æ ‡¶¨‡¶ú‡¶æ‡ßü ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç
                        <span class="text-blue-600 dark:text-blue-400">‡¶´‡ßã‡¶® ‡¶ï‡¶≤ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</span>,
                        <span class="text-yellow-600 dark:text-yellow-400">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</span> ‡¶ì
                        <span class="text-pink-600 dark:text-pink-400">‡¶®‡ßã‡¶ü</span> ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-row items-center justify-center gap-3 w-full md:w-auto">
                <!-- Add StudentButton -->
                <button id="openStudentPanel"
                    class="relative overflow-hidden flex items-center gap-2 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 text-white px-5 py-2.5 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 active:translate-y-0 active:scale-[0.98] font-medium">

                    <!-- Animated background shine effect -->
                    <span
                        class="absolute inset-0 bg-gradient-to-r from-white/20 via-white/0 to-white/20 opacity-0 hover:opacity-100 transition-opacity duration-500 -translate-x-full hover:translate-x-full"></span>

                    <!-- Button content -->
                    <span class="relative z-10 flex items-center gap-2">
                        <i class="fas fa-plus text-sm transition-transform hover:scale-110"></i>
                        <span class="text-sm tracking-wide">Add Student</span>
                    </span>

                    <!-- Click effect (works without JS) -->
                    <span
                        class="absolute inset-0 rounded-lg opacity-0 active:opacity-100 active:bg-white/20 transition-opacity duration-300"></span>
                </button>

                <!-- Dark Mode Toggle -->
                <div id="darkModeToggle"
                    class="w-16 h-9 flex items-center bg-gray-200 dark:bg-gray-600 rounded-full p-1 cursor-pointer transition-all duration-300 shadow-inner">
                    <div id="toggleThumb"
                        class="bg-white dark:bg-yellow-400 w-7 h-7 rounded-full shadow-md transform transition-all duration-300 flex items-center justify-center">
                        <span id="toggleIcon" class="text-sm">üåô</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-4 space-y-6">
        <!-- Dashboard Summary -->
        <section class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 xl:grid-cols-7 gap-3">
            <!-- Total Students -->
            <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-md p-5 flex flex-col items-center justify-center border-2 border-blue-400 dark:border-blue-600 transition-all duration-300 hover:bg-blue-50 dark:hover:bg-blue-950">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-blue-100 dark:bg-blue-800 rounded-full">
                        <i class="fas fa-users text-blue-600 dark:text-blue-300 text-2xl"></i>
                    </div>
                    <p id="totalStudents" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <h3 class="mt-3 text-gray-600 dark:text-gray-400 text-sm font-semibold text-center">Total</h3>
            </div>

            <!-- Called -->
            <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-md p-5 flex flex-col items-center justify-center border-2 border-purple-400 dark:border-purple-600 transition-all duration-300 hover:bg-purple-50 dark:hover:bg-purple-950">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-purple-100 dark:bg-purple-800 rounded-full">
                        <i class="fas fa-phone text-purple-600 dark:text-purple-300 text-2xl"></i>
                    </div>
                    <p id="calledStudents" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <h3 class="mt-3 text-gray-600 dark:text-gray-400 text-sm font-semibold text-center">Called</h3>
            </div>

            <!-- Follow-Up -->
            <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-md p-5 flex flex-col items-center justify-center border-2 border-yellow-400 dark:border-yellow-600 transition-all duration-300 hover:bg-yellow-50 dark:hover:bg-yellow-950">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-yellow-100 dark:bg-yellow-800 rounded-full">
                        <i class="fas fa-exclamation-circle text-yellow-600 dark:text-yellow-300 text-2xl"></i>
                    </div>
                    <p id="followupStudents" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <h3 class="mt-3 text-gray-600 dark:text-gray-400 text-sm font-semibold text-center">Follow-Up</h3>
            </div>

            <!-- Agreed -->
            <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-md p-5 flex flex-col items-center justify-center border-2 border-green-400 dark:border-green-600 transition-all duration-300 hover:bg-green-50 dark:hover:bg-green-950">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-green-100 dark:bg-green-800 rounded-full">
                        <i class="fas fa-handshake text-green-600 dark:text-green-300 text-2xl"></i>
                    </div>
                    <p id="agreedStudents" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <h3 class="mt-3 text-gray-600 dark:text-gray-400 text-sm font-semibold text-center">Agreed</h3>
            </div>

            <!-- Not Interested -->
            <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-md p-5 flex flex-col items-center justify-center border-2 border-red-400 dark:border-red-600 transition-all duration-300 hover:bg-red-50 dark:hover:bg-red-950">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-red-100 dark:bg-red-800 rounded-full">
                        <i class="fas fa-ban text-red-600 dark:text-red-300 text-2xl"></i>
                    </div>
                    <p id="noneStudents" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <h3 class="mt-3 text-gray-600 dark:text-gray-400 text-sm font-semibold text-center">Not Interested</h3>
            </div>

            <!-- Need Phone No. -->
            <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-md p-5 flex flex-col items-center justify-center border-2 border-gray-400 dark:border-gray-600 transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-gray-300 dark:bg-gray-700 rounded-full">
                        <i class="fas fa-phone-slash text-gray-800 dark:text-white text-2xl"></i>
                    </div>
                    <p id="needPhoneNumbers" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <h3 class="mt-3 text-gray-600 dark:text-gray-400 text-sm font-semibold text-center">Need Phone No.</h3>
            </div>

            <!-- Paid -->
            <div
                class="bg-white dark:bg-gray-900 rounded-2xl shadow-md p-5 flex flex-col items-center justify-center border-2 border-emerald-400 dark:border-emerald-600 transition-all duration-300 hover:bg-emerald-50 dark:hover:bg-emerald-950">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-emerald-100 dark:bg-emerald-800 rounded-full">
                        <i class="fas fa-check-circle text-emerald-600 dark:text-emerald-300 text-2xl"></i>
                    </div>
                    <p id="paidStudents" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
                </div>
                <h3 class="mt-3 text-gray-600 dark:text-gray-400 text-sm font-semibold text-center">Paid</h3>
            </div>
        </section>

        <!-- Search & Filters Section -->
        <section id="filterSection"
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-3 border border-gray-200 dark:border-gray-700 md:sticky md:top-0 z-10 transition-all">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">

                <!-- Search Input with Icon -->
                <div class="relative md:col-span-1">
                    <input id="searchInput" type="text" placeholder="Search phone, names, institution"
                        class="w-full pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-300" />
                    <div
                        class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-300">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <!-- Status Filter with Icons -->
                <div class="relative">
                    <select id="statusFilter"
                        class="w-full appearance-none bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-200 font-medium">
                        <option value="">All Statuses</option>
                        <option value="Not Checked">Not Checked</option>
                        <option value="Called">Called</option>
                        <option value="Follow-Up Needed">Follow-Up Needed</option>
                        <option value="Agreed">Agreed</option>
                        <option value="Paid">Paid</option>
                        <option value="Not Interested">Not Interested</option>
                        <option value="Need Phone-Number">Need Phone-Number</option>
                    </select>
                    <div
                        class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-400 dark:text-gray-300">
                        <i class="fas fa-chevron-down text-sm"></i>
                    </div>
                </div>

                <!-- Class Filter -->
                <select id="classFilter"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">Select Institution</option>
                    <option value="bishwo-dorbar-school">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶¶‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="wahedunnesa-school">‡¶ì‡ßü‡¶æ‡¶π‡ßá‡¶¶‡ßÅ‡¶®‡ßç‡¶®‡ßá‡¶∏‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="mithachora-high-school">‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="maruf-model-school">‡¶Æ‡¶æ‡¶∞‡ßÅ‡¶´ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="mithanala-high-school">‡¶Æ‡¶ø‡¶†‡¶æ‡¶®‡¶æ‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="durgapur-high-school">‡¶¶‡ßÇ‡¶∞‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="bamon-sundor-school">‡¶¨‡¶æ‡¶Æ‡¶® ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="sufia-high-school">‡¶∏‡ßÅ‡¶´‡¶ø‡ßü‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="jhulanpol-high-school">‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="majharul-haque-school">‡¶Æ‡¶æ‡¶ú‡¶π‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                    <option value="madbarhat-fazil-madrasa">‡¶Æ‡¶æ‡¶¶‡¶¨‡¶æ‡¶∞‡¶π‡¶æ‡¶ü ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ</option>
                    <option value="mithachora-fazil-madrasa">‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ</option>
                    <option value="jhulanpol-baitus-sharaf">‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶¨‡¶æ‡¶á‡¶§‡ßÅ‡¶∂ ‡¶∂‡¶∞‡¶´ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ</option>

                </select>

                <!-- Group Filter -->
                <select id="groupFilter"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">All Groups</option>
                    <option value="General">General</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commerce">Commerce</option>
                </select>
            </div>

            <!-- Additional Filters -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <!-- Class Grade Filter -->
                <select id="classGradeFilter"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">All Classes (6-12)</option>
                    <option value="6">Class 6</option>
                    <option value="7">Class 7</option>
                    <option value="8">Class 8</option>
                    <option value="9">Class 9</option>
                    <option value="10">Class 10</option>
                    <option value="11">Class 11</option>
                    <option value="12">Class 12</option>
                </select>

                <!-- Date Range Filter -->
                <div class="col-span-2 grid grid-cols-2 gap-2">
                    <div class="flex flex-col">
                        <label for="startDateFilter" class="mb-1 text-xs font-medium text-gray-600 dark:text-gray-300">
                            From Date
                        </label>
                        <input type="date" id="startDateFilter" placeholder="From Date"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="flex flex-col">
                        <label for="endDateFilter" class="mb-1 text-xs font-medium text-gray-600 dark:text-gray-300">
                            To Date
                        </label>
                        <input type="date" id="endDateFilter" placeholder="To Date"
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>

                <!-- Reset Filters Button -->
                <button id="resetFilters"
                    class="w-full px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-sync-alt"></i> Reset Filters
                </button>
            </div>

            <!-- Footer Section -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-sm text-gray-600 dark:text-gray-300">
                    Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> students
                </div>

                <!-- Pagination Buttons -->
                <div class="flex space-x-2">
                    <button id="prevPage"
                        class="px-4 py-2 border rounded-lg hover:bg-blue-500 hover:text-white transition disabled:opacity-50 dark:border-gray-500">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageInfo" class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200">Page 1</span>
                    <button id="nextPage"
                        class="px-4 py-2 border rounded-lg hover:bg-blue-500 hover:text-white transition disabled:opacity-50 dark:border-gray-500">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Student List Section -->
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <div id="studentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Student cards will be injected here -->
                <div class="col-span-full text-center py-10">
                    <i class="fas fa-user-graduate text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">Loading students...</p>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-semibold mb-6">Admission Analytics</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Students by Institution</h3>
                    <div class="h-[300px]">
                        <canvas id="classChart"></canvas>
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Students by Status</h3>
                    <div class="h-[300px]">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Students by Class (6-12)</h3>
                    <div class="h-[300px]">
                        <canvas id="classGradeChart"></canvas>
                    </div>
                </div>
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-4">Admission Progress</h3>
                    <div class="h-[300px]">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Data Management Section -->
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-semibold mb-4">Data Management</h2>
            <div class="flex flex-wrap gap-4">
                <button id="exportCSV"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition flex items-center gap-2">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button id="exportPDF"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <label for="importCSV"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition flex items-center gap-2 cursor-pointer">
                    <i class="fas fa-file-import"></i> Import CSV
                    <input type="file" id="importCSV" accept=".csv, text/csv" class="hidden">
                </label>
                <button id="backupJSON"
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition flex items-center gap-2">
                    <i class="fas fa-file-export"></i> Backup JSON
                </button>
                <label for="restoreJSON"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition flex items-center gap-2 cursor-pointer">
                    <i class="fas fa-file-import"></i> Restore JSON
                    <input type="file" id="restoreJSON" accept=".json,application/json" class="hidden">
                </label>
            </div>
        </section>
    </main>

    <!-- Student Panel Modal -->
    <div id="studentPanelModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl w-full max-w-3xl mx-4 border border-gray-200 dark:border-gray-700 max-h-[90vh] overflow-y-auto p-4">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white dark:bg-gray-800 z-10 py-2">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Add Student</h2>
                <button id="closeStudentPanel"
                    class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="studentForm" class="grid grid-cols-2 gap-x-4 gap-y-4">
                <!-- Name -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="name" class="block text-sm font-medium mb-1 dark:text-gray-200">Name*</label>
                    <input type="text" id="name" required
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>

                <!-- Phone -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="phone" class="block text-sm font-medium mb-1 dark:text-gray-200">Phone*</label>
                    <input type="tel" id="phone" required
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>

                <!-- Class -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="class" class="block text-sm font-medium mb-1 dark:text-gray-200">Institution*</label>
                    <select id="class" required
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Institution</option>
                        <option value="bishwo-dorbar-school">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶¶‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="wahedunnesa-school">‡¶ì‡ßü‡¶æ‡¶π‡ßá‡¶¶‡ßÅ‡¶®‡ßç‡¶®‡ßá‡¶∏‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="mithachora-high-school">‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="maruf-model-school">‡¶Æ‡¶æ‡¶∞‡ßÅ‡¶´ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="mithanala-high-school">‡¶Æ‡¶ø‡¶†‡¶æ‡¶®‡¶æ‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="durgapur-high-school">‡¶¶‡ßÇ‡¶∞‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="bamon-sundor-school">‡¶¨‡¶æ‡¶Æ‡¶® ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="sufia-high-school">‡¶∏‡ßÅ‡¶´‡¶ø‡ßü‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="jhulanpol-high-school">‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="majharul-haque-school">‡¶Æ‡¶æ‡¶ú‡¶π‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</option>
                        <option value="madbarhat-fazil-madrasa">‡¶Æ‡¶æ‡¶¶‡¶¨‡¶æ‡¶∞‡¶π‡¶æ‡¶ü ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ</option>
                        <option value="mithachora-fazil-madrasa">‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ</option>
                        <option value="jhulanpol-baitus-sharaf">‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶¨‡¶æ‡¶á‡¶§‡ßÅ‡¶∂ ‡¶∂‡¶∞‡¶´ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ</option>

                    </select>
                </div>

                <!-- Class Grade -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="classGrade" class="block text-sm font-medium mb-1 dark:text-gray-200">Class*</label>
                    <select id="classGrade" required
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Select Class</option>
                        <option value="6">Class 6</option>
                        <option value="7">Class 7</option>
                        <option value="8">Class 8</option>
                        <option value="9">Class 9</option>
                        <option value="10">Class 10</option>
                        <option value="11">Class 11</option>
                        <option value="12">Class 12</option>
                    </select>
                </div>

                <!-- Group -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="group" class="block text-sm font-medium mb-1 dark:text-gray-200">Group</label>
                    <select id="group"
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="None">None</option>
                        <option value="General">General</option>
                        <option value="Science">Science</option>
                        <option value="Arts">Arts</option>
                        <option value="Commerce">Commerce</option>
                    </select>
                </div>

                <!-- Date -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="date" class="block text-sm font-medium mb-1 dark:text-gray-200">Date*</label>
                    <input type="date" id="date" required
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>

                <!-- Status -->
                <div class="col-span-2 sm:col-span-1">
                    <label for="status" class="block text-sm font-medium mb-1 dark:text-gray-200">Status*</label>
                    <select id="status" required
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="Not Checked">Not Checked</option>
                        <option value="Called">Called</option>
                        <option value="Follow-Up Needed">Follow-Up Needed</option>
                        <option value="Agreed">Agreed</option>
                        <option value="Paid">Paid</option>
                        <option value="Not Interested">Not Interested</option>
                        <option value="Need Phone-Number">Need Phone-Number</option>
                    </select>
                </div>

                <!-- Additional Info -->
                <div class="col-span-2">
                    <label for="info" class="block text-sm font-medium mb-1 dark:text-gray-200">Additional Info</label>
                    <textarea id="info" rows="3"
                        class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="col-span-2">
                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-md transition flex items-center justify-center gap-2 text-lg">
                        <i class="fas fa-save"></i> Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div
            class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-200 dark:border-gray-700">
            <h2 id="confirmModalTitle" class="text-xl font-bold mb-4">Confirm Action</h2>
            <p id="confirmModalMessage" class="mb-6">Are you sure you want to perform this action?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelConfirm"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition">
                    Cancel
                </button>
                <button id="proceedConfirm"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ================ INITIALIZATION ================
            // Supabase configuration
            const supabaseUrl = 'https://erihbeinkymnymncnawm.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyaWhiZWlua3ltbnltbmNuYXdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NzEwMzUsImV4cCI6MjA2MjM0NzAzNX0.xhE0_RbBQ9qQcYHa5sv-S9-cUolJruo0Km3oud-GtOM';
            const supabaseMain = supabase.createClient(supabaseUrl, supabaseKey);

            // App state
            let students = [];
            let filteredStudents = [];
            let currentPage = 1;
            const studentsPerPage = 12;
            let currentEditingId = null;
            let pendingAction = null;
            let pendingActionData = null;

            // Chart Instances
            let classChart, statusChart, classGradeChart, progressChart;

            // Status Configuration - Updated for card backgrounds
            const statusConfig = {
                "Not Checked": {
                    icon: '<i class="fas fa-question-circle mr-1"></i>',
                    bg: 'bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-800',
                    text: 'text-gray-800 dark:text-gray-200',
                    iconColor: 'text-gray-500 dark:text-gray-400'
                },
                "Called": {
                    icon: '<i class="fas fa-phone-alt mr-1"></i>',
                    bg: 'bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-800 dark:to-purple-900',
                    text: 'text-purple-800 dark:text-purple-100',
                    iconColor: 'text-purple-500 dark:text-purple-300'
                },
                "Follow-Up Needed": {
                    icon: '<i class="fas fa-exclamation-circle mr-1"></i>',
                    bg: 'bg-gradient-to-r from-amber-50 to-amber-100 dark:from-amber-800 dark:to-amber-900',
                    text: 'text-amber-800 dark:text-amber-100',
                    iconColor: 'text-amber-500 dark:text-amber-300'
                },
                "Agreed": {
                    icon: '<i class="fas fa-handshake mr-1"></i>',
                    bg: 'bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-800 dark:to-blue-900',
                    text: 'text-blue-800 dark:text-blue-100',
                    iconColor: 'text-blue-500 dark:text-blue-300'
                },
                "Paid": {
                    icon: '<i class="fas fa-check-circle mr-1"></i>',
                    bg: 'bg-gradient-to-r from-emerald-50 to-emerald-100 dark:from-emerald-800 dark:to-emerald-900',
                    text: 'text-emerald-800 dark:text-emerald-100',
                    iconColor: 'text-emerald-500 dark:text-emerald-300'
                },
                "Not Interested": {
                    icon: '<i class="fas fa-ban mr-1"></i>',
                    bg: 'bg-gradient-to-r from-red-50 to-red-100 dark:from-red-800 dark:to-red-900',
                    text: 'text-red-800 dark:text-red-100',
                    iconColor: 'text-red-500 dark:text-red-300'
                },
                "Need Phone-Number": {
                    icon: '<i class="fas fa-phone-slash mr-1"></i>',
                    bg: 'bg-[#808080] dark:bg-white',
                    text: 'text-white dark:text-black',
                    iconColor: 'text-white dark:text-black'
                }
            };

            // Status Configuration for PDF
            const statusConfigs = {
                "Called": { pdfColor: "#3498db" },
                "Follow-Up Needed": { pdfColor: "#f1c40f" },
                "Agreed": { pdfColor: "#2ecc71" },
                "Not Interested": { pdfColor: "#e74c3c" },
                "Paid": { pdfColor: "#9b59b6" },
                "Not Checked": { pdfColor: "#95a5a6" },
                "Need Phone-Number": { pdfColor: "#4d4d4d" }
            };

            // DOM Elements
            const loadingOverlay = document.getElementById('loadingOverlay');
            const studentPanelModal = document.getElementById('studentPanelModal');
            const openStudentPanel = document.getElementById('openStudentPanel');
            const closeStudentPanel = document.getElementById('closeStudentPanel');
            const modalTitle = document.getElementById('modalTitle');
            const studentForm = document.getElementById('studentForm');
            const studentList = document.getElementById('studentList');
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const classFilter = document.getElementById('classFilter');
            const groupFilter = document.getElementById('groupFilter');
            const classGradeFilter = document.getElementById('classGradeFilter');
            const startDateFilter = document.getElementById('startDateFilter');
            const endDateFilter = document.getElementById('endDateFilter');
            const resetFilters = document.getElementById('resetFilters');
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');
            const showingCount = document.getElementById('showingCount');
            const totalCount = document.getElementById('totalCount');
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalTitle = document.getElementById('confirmModalTitle');
            const confirmModalMessage = document.getElementById('confirmModalMessage');
            const cancelConfirm = document.getElementById('cancelConfirm');
            const proceedConfirm = document.getElementById('proceedConfirm');
            const exportCSV = document.getElementById('exportCSV');
            const exportPDF = document.getElementById('exportPDF');
            const backupJSON = document.getElementById('backupJSON');
            const importCSV = document.getElementById('importCSV');
            const restoreJSON = document.getElementById('restoreJSON');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const toggleThumb = document.getElementById('toggleThumb');
            const toggleIcon = document.getElementById('toggleIcon');
            const filterSection = document.getElementById('filterSection');

            // Dashboard Elements
            const dashboardElements = {
                total: document.getElementById('totalStudents'),
                called: document.getElementById('calledStudents'),
                followup: document.getElementById('followupStudents'),
                agreed: document.getElementById('agreedStudents'),
                none: document.getElementById('noneStudents'),
                paid: document.getElementById('paidStudents'),
                NeedPhoneNumber: document.getElementById('needPhoneNumbers')
            };


            // ================ UTILITY FUNCTIONS ================
            const showLoading = () => {
                loadingOverlay.classList.remove('hidden');
            };

            const hideLoading = () => {
                loadingOverlay.classList.add('hidden');
            };

            const showToast = (message, type = 'info') => {
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };

                toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-md shadow-lg transition-opacity duration-300 opacity-0 flex items-center gap-2`;
                toast.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                `;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.replace('opacity-0', 'opacity-100'), 10);

                setTimeout(() => {
                    toast.classList.replace('opacity-100', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };

            const debounce = (func, wait) => {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            };

            const formatDate = (dateString) => {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            };

            const validatePhone = (phone) => {
                const regex = /^[0-9]{10,15}$/;
                return regex.test(phone);
            };

            const showConfirmation = (title, message, action, data = null) => {
                pendingAction = action;
                pendingActionData = data;
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmModal.classList.remove('hidden');
            };

            // Convert hex to RGB
            const hexToRgb = (hex) => {
                const bigint = parseInt(hex.replace('#', ''), 16);
                return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
            };

            // Helper function to properly parse CSV lines with quoted fields
            const parseCSVLine = (line) => {
                const pattern = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
                const values = [];
                let match;

                while ((match = pattern.exec(line)) !== null) {
                    let value = match[0];
                    if (value.startsWith(',')) value = value.substring(1);
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1).replace(/""/g, '"');
                    }
                    values.push(value);
                }

                return values;
            };

            // ================ DATA FUNCTIONS ================
            const fetchStudents = async () => {
                showLoading();
                try {
                    const { data, error } = await supabaseMain
                        .from('mmmcStudents')
                        .select('*')
                        .order('date', { ascending: false });

                    if (error) throw error;

                    students = data || [];
                    filteredStudents = [...students];
                    renderStudents();
                    updateDashboard();
                    updateCharts();
                } catch (error) {
                    console.error('Error fetching students:', error);
                    showToast('Failed to load students. Using local data.', 'error');
                    const localData = localStorage.getItem('admissionTrackerData');
                    if (localData) {
                        students = JSON.parse(localData);
                        filteredStudents = [...students];
                        renderStudents();
                        updateDashboard();
                        updateCharts();
                    }
                } finally {
                    hideLoading();
                }
            };

            const saveStudent = async (studentData, id = null) => {
                showLoading();
                try {
                    if (!studentData.name || !studentData.phone || !studentData.class || !studentData.classGrade || !studentData.date) {
                        throw new Error('Please fill all required fields');
                    }

                    if (!validatePhone(studentData.phone)) {
                        throw new Error('Please enter a valid phone number (10-15 digits)');
                    }

                    let result;
                    if (id) {
                        const { data, error } = await supabaseMain
                            .from('mmmcStudents')
                            .update(studentData)
                            .eq('id', id)
                            .select();

                        if (error) throw error;
                        result = data[0];
                        showToast('Student updated successfully!', 'success');
                    } else {
                        const { data, error } = await supabaseMain
                            .from('mmmcStudents')
                            .insert([studentData])
                            .select();

                        if (error) throw error;
                        result = data[0];
                        showToast('Student added successfully!', 'success');
                    }

                    if (id) {
                        const index = students.findIndex(s => s.id === id);
                        if (index !== -1) students[index] = result;
                    } else {
                        students.unshift(result);
                    }

                    filteredStudents = [...students];
                    renderStudents();
                    updateDashboard();
                    updateCharts();
                    return true;
                } catch (error) {
                    console.error('Error saving student:', error);
                    showToast(error.message || 'Failed to save student', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            };

            const deleteStudent = async (id) => {
                showLoading();
                try {
                    const { error } = await supabaseMain
                        .from('mmmcStudents')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    students = students.filter(student => student.id !== id);
                    filteredStudents = filteredStudents.filter(student => student.id !== id);

                    renderStudents();
                    updateDashboard();
                    updateCharts();
                    showToast('Student deleted successfully!', 'success');
                    return true;
                } catch (error) {
                    console.error('Error deleting student:', error);
                    showToast('Failed to delete student', 'error');
                    return false;
                } finally {
                    hideLoading();
                }
            };

            const exportToCSV = () => {
                showLoading();
                try {
                    // Create CSV headers
                    const headers = ['Sl No', 'Name', 'Phone', 'Institution', 'Class', 'Group', 'Date', 'Status', 'Info'];

                    // Process data rows with proper CSV escaping
                    const rows = students.map((student, index) => {
                        return [
                            index + 1,
                            `"${student.name.replace(/"/g, '""')}"`, // Properly escape quotes in names
                            student.phone,
                            student.class,
                            student.classGrade,
                            student.group,
                            student.date,
                            student.status,
                            student.info ? `"${student.info.replace(/"/g, '""')}"` : ''
                        ];
                    });

                    // Combine headers and rows
                    const csvContent = [headers, ...rows]
                        .map(row => row.join(','))
                        .join('\n');

                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `students_export_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showToast('CSV exported successfully!', 'success');
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                    showToast('Failed to export CSV', 'error');
                } finally {
                    hideLoading();
                }
            };

            const exportToPDF = () => {
                showLoading();
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // Title & Meta - First page header
                    doc.setFontSize(18);
                    doc.setTextColor(40);
                    doc.text('Admission Tracker Pro - Student Report', 105, 20, { align: 'center' });

                    doc.setFontSize(10);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()} Developed by Mustafa Rahman - Software Engineer, Contact:01840643946 `, 105, 27, { align: 'center' });
                    doc.text(`Total Students: ${filteredStudents.length}`, 105, 32, { align: 'center' });

                    // Statistics section
                    const stats = [
                        { label: "Called", value: filteredStudents.filter(s => s.status === 'Called').length },
                        { label: "Follow-Up", value: filteredStudents.filter(s => s.status === 'Follow-Up Needed').length },
                        { label: "Agreed", value: filteredStudents.filter(s => s.status === 'Agreed').length },
                        { label: "Paid", value: filteredStudents.filter(s => s.status === 'Paid').length },
                        { label: "Not Interested", value: filteredStudents.filter(s => s.status === 'Not Interested').length },
                        { label: "Not Checked", value: filteredStudents.filter(s => s.status === 'Not Checked').length },
                        { label: "Need Phone-Number", value: filteredStudents.filter(s => s.status === 'Need Phone-Number').length }
                    ];

                    let startX = 15;
                    let posX = startX;
                    let posY = 43;
                    doc.setFontSize(10);

                    stats.forEach(stat => {
                        let config;
                        // Special case for Follow-Up to use the specified color
                        if (stat.label === "Follow-Up") {
                            config = { pdfColor: '#f59e0b' };
                        } else {
                            config = statusConfigs[stat.label] || statusConfigs["Not Checked"];
                        }

                        const text = `${stat.label}: ${stat.value}`;
                        const textWidth = doc.getTextWidth(text) + 6;

                        if (posX + textWidth > 190) {
                            posX = startX;
                            posY += 10;
                        }

                        const rgb = hexToRgb(config.pdfColor || '#cccccc');
                        doc.setFillColor(...rgb);
                        doc.setTextColor(255);
                        doc.roundedRect(posX, posY, textWidth, 8, 2, 2, 'F');
                        doc.text(text, posX + 3, posY + 5.5);

                        posX += textWidth + 4;
                    });

                    // Table data - using filteredStudents instead of all students
                    const headers = [['Sl No', 'Name', 'Phone', 'Institution', 'Class', 'Group', 'Status', 'Query Date']];
                    const data = filteredStudents.map((student, index) => [
                        index + 1,
                        student.name.length > 20 ? student.name.substring(0, 17) + '...' : student.name,
                        student.phone,
                        student.class,
                        student.classGrade,
                        student.group,
                        student.status,
                        formatDate(student.date)
                    ]);

                    // Add header and footer to all pages
                    doc.autoTable({
                        head: headers,
                        body: data,
                        startY: posY + 12,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [41, 128, 185],
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        styles: {
                            fontSize: 8,
                            cellPadding: 2,
                            overflow: 'linebreak',
                            valign: 'middle'
                        },
                        columnStyles: {
                            0: { cellWidth: 10, halign: 'center' },
                            1: { cellWidth: 35 },
                            2: { cellWidth: 25 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 15, halign: 'center' },
                            5: { cellWidth: 15, halign: 'center' },
                            6: { cellWidth: 20 },
                            7: { cellWidth: 20, halign: 'center' }
                        },
                        didParseCell: (data) => {
                            if (data.section === 'body' && data.column.index === 6) {
                                const status = data.cell.raw;
                                const config = statusConfigs[status] || statusConfigs["Not Checked"];
                                const rgb = hexToRgb(config.pdfColor || '#000000');
                                data.cell.styles.textColor = rgb;
                            }
                        },
                        margin: { top: posY + 12 },
                        didDrawPage: function (data) {
                            // Header for pages after the first
                            if (data.pageNumber > 1) {
                                doc.setFontSize(18);
                                doc.setTextColor(40);
                                doc.text('Admission Tracker Pro - Student Report', 105, 20, { align: 'center' });

                                doc.setFontSize(10);
                                doc.text(`Generated on: ${new Date().toLocaleDateString()} Developed by Mustafa Rahman`, 105, 27, { align: 'center' });
                                doc.text(`Total Students: ${filteredStudents.length}`, 105, 32, { align: 'center' });
                            }

                            // Footer for all pages
                            doc.setFontSize(10);
                            doc.setTextColor(100);
                            const footerText = `Developed by Mustafa Rahman -Software Engineer, Contact: 01840643946 | by Admission Tracker Pro software`;
                            doc.text(footerText, 105, doc.internal.pageSize.height - 10, { align: 'center' });

                            // Page numbering
                            const pageCount = doc.internal.getNumberOfPages();
                            doc.text(`Page ${data.pageNumber} of ${pageCount}`, 105, doc.internal.pageSize.height - 15, { align: 'center' });
                        }
                    });

                    // Save
                    doc.save(`students_report_${new Date().toISOString().slice(0, 10)}.pdf`);
                    showToast('PDF exported successfully!', 'success');
                } catch (error) {
                    console.error('Error exporting PDF:', error);
                    showToast('Failed to export PDF', 'error');
                } finally {
                    hideLoading();
                }
            };

            const backupToJSON = () => {
                showLoading();
                try {
                    const dataStr = JSON.stringify(students, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `students_backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    showToast('JSON backup created!', 'success');
                } catch (error) {
                    console.error('Error creating backup:', error);
                    showToast('Failed to create backup', 'error');
                } finally {
                    hideLoading();
                }
            };

            const restoreFromJSON = (file) => {
                showLoading();
                const reader = new FileReader();

                reader.onload = async (event) => {
                    try {
                        const jsonData = event.target.result;
                        const parsedData = JSON.parse(jsonData);

                        if (!Array.isArray(parsedData)) {
                            throw new Error('Invalid JSON format. Expected an array of student data.');
                        }

                        const validStudents = parsedData.filter(student => {
                            return student.name && student.phone && student.class && student.date && student.status;
                        });

                        if (validStudents.length === 0) {
                            throw new Error('No valid student records found in JSON file');
                        }

                        showConfirmation(
                            'Restore Data',
                            `This will import ${validStudents.length} student records. Existing data will be preserved. Continue?`,
                            'restoreData',
                            validStudents
                        );
                    } catch (error) {
                        console.error('Error restoring from JSON:', error);
                        showToast(error.message || 'Failed to restore from JSON', 'error');
                    } finally {
                        hideLoading();
                        restoreJSON.value = '';
                    }
                };

                reader.onerror = () => {
                    hideLoading();
                    showToast('Error reading JSON file', 'error');
                    restoreJSON.value = '';
                };

                reader.readAsText(file);
            };

            const performRestore = async (studentsToRestore) => {
                showLoading();
                try {
                    const { data, error } = await supabaseMain
                        .from('mmmcStudents')
                        .insert(studentsToRestore)
                        .select();

                    if (error) throw error;

                    students.unshift(...data);
                    filteredStudents = [...students];

                    renderStudents();
                    updateDashboard();
                    updateCharts();
                    showToast(`Successfully restored ${data.length} students`, 'success');
                } catch (error) {
                    console.error('Error restoring data:', error);
                    showToast('Failed to restore data', 'error');
                } finally {
                    hideLoading();
                }
            };

            const importFromCSV = (file) => {
                showLoading();
                const reader = new FileReader();

                reader.onload = async (event) => {
                    try {
                        const csvData = event.target.result;
                        const lines = csvData.split('\n').filter(line => line.trim().length > 0);

                        // Parse headers and find column indices
                        const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
                        const nameIndex = headers.findIndex(h => h.toLowerCase() === 'name');
                        const phoneIndex = headers.findIndex(h => h.toLowerCase() === 'phone');
                        // Try to find "institution" or "class" column
                        let classIndex = headers.findIndex(h => h.toLowerCase() === 'institution');
                        if (classIndex === -1) classIndex = headers.findIndex(h => h.toLowerCase() === 'class');
                        const classGradeIndex = headers.findIndex(h => h.toLowerCase().includes('grade') || h.toLowerCase().includes('class grade') || h.toLowerCase() === 'classgrade');
                        const groupIndex = headers.findIndex(h => h.toLowerCase() === 'group');
                        const dateIndex = headers.findIndex(h => h.toLowerCase() === 'date');
                        const statusIndex = headers.findIndex(h => h.toLowerCase() === 'status');
                        const infoIndex = headers.findIndex(h => h.toLowerCase() === 'info');

                        if (nameIndex === -1 || phoneIndex === -1 || classIndex === -1) {
                            throw new Error('CSV must contain at least Name, Phone, and Institution/Class columns');
                        }

                        // Map Bengali/English institution names to internal keys (case-insensitive, whitespace-insensitive)
                        const institutionMap = {
                            "bishwo-dorbar-school": "bishwo-dorbar-school",
                            "‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶¶‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "bishwo-dorbar-school",
                            "wahedunnesa-school": "wahedunnesa-school",
                            "‡¶ì‡ßü‡¶æ‡¶π‡ßá‡¶¶‡ßÅ‡¶®‡ßç‡¶®‡ßá‡¶∏‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "wahedunnesa-school",
                            "mithachora-high-school": "mithachora-high-school",
                            "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "mithachora-high-school",
                            "maruf-model-school": "maruf-model-school",
                            "‡¶Æ‡¶æ‡¶∞‡ßÅ‡¶´ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "maruf-model-school",
                            "mithanala-high-school": "mithanala-high-school",
                            "‡¶Æ‡¶ø‡¶†‡¶æ‡¶®‡¶æ‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "mithanala-high-school",
                            "durgapur-high-school": "durgapur-high-school",
                            "‡¶¶‡ßÇ‡¶∞‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "durgapur-high-school",
                            "bamon-sundor-school": "bamon-sundor-school",
                            "‡¶¨‡¶æ‡¶Æ‡¶® ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "bamon-sundor-school",
                            "sufia-high-school": "sufia-high-school",
                            "‡¶∏‡ßÅ‡¶´‡¶ø‡ßü‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "sufia-high-school",
                            "jhulanpol-high-school": "jhulanpol-high-school",
                            "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "jhulanpol-high-school",
                            "majharul-haque-school": "majharul-haque-school",
                            "‡¶Æ‡¶æ‡¶ú‡¶π‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü": "majharul-haque-school",
                            "madbarhat-fazil-madrasa": "madbarhat-fazil-madrasa",
                            "‡¶Æ‡¶æ‡¶¶‡¶¨‡¶æ‡¶∞‡¶π‡¶æ‡¶ü ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ": "madbarhat-fazil-madrasa",
                            "mithachora-fazil-madrasa": "mithachora-fazil-madrasa",
                            "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ": "mithachora-fazil-madrasa",
                            "jhulanpol-baitus-sharaf": "jhulanpol-baitus-sharaf",
                            "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶¨‡¶æ‡¶á‡¶§‡ßÅ‡¶∂ ‡¶∂‡¶∞‡¶´ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ": "jhulanpol-baitus-sharaf"
                        };
                        // Helper to normalize institution names for matching
                        const normalizeInstitution = (str) => (str || '').toLowerCase().replace(/\s+/g, '').replace(/"/g, '');

                        const newStudents = [];
                        const errors = [];

                        for (let i = 1; i < lines.length; i++) {
                            try {
                                const values = parseCSVLine(lines[i]);
                                if (!values[nameIndex] || !values[phoneIndex] || !values[classIndex]) {
                                    errors.push(`Skipping row ${i + 1}: Missing required fields`);
                                    continue;
                                }

                                // Try to map institution smartly
                                let classValueRaw = values[classIndex].trim();
                                let classValue = institutionMap[classValueRaw]
                                    || institutionMap[normalizeInstitution(classValueRaw)]
                                    || institutionMap[classValueRaw.replace(/\s+/g, '')]
                                    || classValueRaw; // fallback to raw if not found

                                // If still not matched, try fuzzy match (contains Bengali or English part)
                                if (!Object.values(institutionMap).includes(classValue)) {
                                    for (const [key, val] of Object.entries(institutionMap)) {
                                        if (
                                            normalizeInstitution(classValueRaw) === normalizeInstitution(key) ||
                                            normalizeInstitution(classValueRaw).includes(normalizeInstitution(key)) ||
                                            normalizeInstitution(key).includes(normalizeInstitution(classValueRaw))
                                        ) {
                                            classValue = val;
                                            break;
                                        }
                                    }
                                }

                                newStudents.push({
                                    name: values[nameIndex].trim(),
                                    phone: values[phoneIndex].trim(),
                                    class: classValue,
                                    classGrade: (classGradeIndex !== -1 && values[classGradeIndex]) ? values[classGradeIndex].trim() : '6',
                                    group: (groupIndex !== -1 && values[groupIndex]) ? values[groupIndex].trim() : 'None',
                                    date: (dateIndex !== -1 && values[dateIndex]) ?
                                        values[dateIndex].trim() :
                                        new Date().toISOString().split('T')[0],
                                    status: (statusIndex !== -1 && values[statusIndex]) ?
                                        values[statusIndex].trim() :
                                        'Not Checked',
                                    info: (infoIndex !== -1 && values[infoIndex]) ? values[infoIndex].trim() : ''
                                });
                            } catch (error) {
                                errors.push(`Error parsing row ${i + 1}: ${error.message}`);
                            }
                        }

                        if (newStudents.length === 0) {
                            throw new Error('No valid student records found in CSV');
                        }

                        if (errors.length > 0) {
                            console.warn('CSV import warnings:', errors);
                        }

                        showConfirmation(
                            'Import CSV',
                            `This will import ${newStudents.length} student records${errors.length > 0 ?
                                ` (${errors.length} rows had issues)` : ''}. Continue?`,
                            'importCSV',
                            newStudents
                        );
                    } catch (error) {
                        console.error('Error importing CSV:', error);
                        showToast(error.message || 'Failed to import CSV', 'error');
                    } finally {
                        hideLoading();
                        importCSV.value = '';
                    }
                };

                reader.onerror = () => {
                    hideLoading();
                    showToast('Error reading CSV file', 'error');
                    importCSV.value = '';
                };

                reader.readAsText(file);
            };

            const performCSVImport = async (studentsToImport) => {
                showLoading();
                try {
                    const { data, error } = await supabaseMain
                        .from('mmmcStudents')
                        .insert(studentsToImport)
                        .select();

                    if (error) throw error;

                    students.unshift(...data);
                    filteredStudents = [...students];

                    renderStudents();
                    updateDashboard();
                    updateCharts();
                    showToast(`Successfully imported ${data.length} students`, 'success');
                } catch (error) {
                    console.error('Error importing students:', error);
                    showToast('Failed to import students', 'error');
                } finally {
                    hideLoading();
                }
            };

            // ================ UI FUNCTIONS ================
            const filterStudents = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const classValue = classFilter.value;
                const groupValue = groupFilter.value;
                const classGradeValue = classGradeFilter.value;
                const startDateValue = startDateFilter.value;
                const endDateValue = endDateFilter.value;
                // Enhanced search: match any field (name, phone, info, class, classGrade, group, status, institution label) efficiently
                filteredStudents = students.filter(student => {
                    // Lowercase search term once for efficiency
                    if (!searchTerm && !statusValue && !classValue && !groupValue && !classGradeValue && !startDateValue && !endDateValue) {
                        return true; // No filters, return all
                    }

                    // Build a single string of all searchable fields for "any data" search
                    const searchFields = [
                        student.name,
                        student.phone,
                        student.info || '',
                        student.class || '',
                        student.classGrade || '',
                        student.group || '',
                        student.status || ''
                    ].join(' ').toLowerCase();

                    // Also match institution label (for Bengali search)
                    const institutionLabels = {
                        "bishwo-dorbar-school": "‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶¶‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "wahedunnesa-school": "‡¶ì‡ßü‡¶æ‡¶π‡ßá‡¶¶‡ßÅ‡¶®‡ßç‡¶®‡ßá‡¶∏‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "mithachora-high-school": "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "maruf-model-school": "‡¶Æ‡¶æ‡¶∞‡ßÅ‡¶´ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "mithanala-high-school": "‡¶Æ‡¶ø‡¶†‡¶æ‡¶®‡¶æ‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "durgapur-high-school": "‡¶¶‡ßÇ‡¶∞‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "bamon-sundor-school": "‡¶¨‡¶æ‡¶Æ‡¶® ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "sufia-high-school": "‡¶∏‡ßÅ‡¶´‡¶ø‡ßü‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "jhulanpol-high-school": "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "majharul-haque-school": "‡¶Æ‡¶æ‡¶ú‡¶π‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                        "madbarhat-fazil-madrasa": "‡¶Æ‡¶æ‡¶¶‡¶¨‡¶æ‡¶∞‡¶π‡¶æ‡¶ü ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ",
                        "mithachora-fazil-madrasa": "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ",
                        "jhulanpol-baitus-sharaf": "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶¨‡¶æ‡¶á‡¶§‡ßÅ‡¶∂ ‡¶∂‡¶∞‡¶´ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ"
                    };
                    const institutionLabel = institutionLabels[student.class] || '';
                    const matchesSearch = !searchTerm ||
                        searchFields.includes(searchTerm) ||
                        institutionLabel.toLowerCase().includes(searchTerm);

                    const matchesStatus = !statusValue || student.status === statusValue;
                    const matchesClass = !classValue || student.class === classValue;
                    const matchesGroup = !groupValue || student.group === groupValue;
                    const matchesClassGrade = !classGradeValue || student.classGrade === classGradeValue;

                    // Date filtering
                    let matchesDate = true;
                    if (startDateValue || endDateValue) {
                        const studentDate = new Date(student.date);
                        const startDate = startDateValue ? new Date(startDateValue) : null;
                        const endDate = endDateValue ? new Date(endDateValue) : null;

                        if (startDate && endDate) {
                            matchesDate = studentDate >= startDate && studentDate <= endDate;
                        } else if (startDate) {
                            matchesDate = studentDate >= startDate;
                        } else if (endDate) {
                            matchesDate = studentDate <= endDate;
                        }
                    }

                    return matchesSearch && matchesStatus && matchesClass && matchesGroup && matchesClassGrade && matchesDate;
                });

                currentPage = 1;
                renderStudents();
                updateDashboard();
                updateCharts();
            };

            const resetAllFilters = () => {
                searchInput.value = '';
                statusFilter.value = '';
                classFilter.value = '';
                groupFilter.value = '';
                classGradeFilter.value = '';
                startDateFilter.value = '';
                endDateFilter.value = '';
                filterStudents();
            };

            const renderStudents = () => {
                const startIndex = (currentPage - 1) * studentsPerPage;
                const endIndex = startIndex + studentsPerPage;
                const paginatedStudents = filteredStudents.slice(startIndex, endIndex);

                studentList.innerHTML = '';

                if (filteredStudents.length === 0) {
                    studentList.innerHTML = `
                        <div class="col-span-full text-center py-10">
                            <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">No students found matching your criteria.</p>
                        </div>
                    `;
                    return;
                }

                paginatedStudents.forEach(student => {
                    const config = statusConfig[student.status] || {
                        icon: '<i class="fas fa-question-circle text-gray-500 mr-1"></i>',
                        classes: 'border-l-gray-500'
                    };

                    // Create tooltip for additional info if it exists
                    const infoTooltip = student.info ? `
                        <div class="tooltip">
                            <i class="fas fa-info-circle ${config.iconColor} cursor-pointer"></i>
                            <span class="tooltiptext">${student.info}</span>
                        </div>
                    ` : '';

                    const card = document.createElement('div');
                    card.className = `rounded-lg shadow-sm hover:shadow-md transition-all overflow-hidden ${config.bg} ${config.text} border border-gray-200 dark:border-gray-700`;

                    card.innerHTML = `
                        <div class="p-4 text-sm">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-base font-semibold truncate">${student.name}</h3>
                                <div class="flex items-center gap-1 ${config.iconColor}">
                                    ${config.icon}
                                    <span class="text-xs">${student.status}</span>
                                </div>
                            </div>

                            <div class="space-y-1 mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-phone-alt ${config.iconColor} text-xs"></i>
                                    <a href="tel:${student.phone}" class="hover:underline">${student.phone}</a>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-school ${config.iconColor} text-xs"></i>
                                    <span>${student.class}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-graduation-cap ${config.iconColor} text-xs"></i>
                                    <span>Class ${student.classGrade}${student.group !== 'None' ? ` (${student.group})` : ''}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar-day ${config.iconColor} text-xs"></i>
                                    <span>${formatDate(student.date)}</span>
                                    ${infoTooltip}
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-1">
                                <button onclick="editStudent('${student.id}')" class="px-2 py-1 bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md text-xs flex items-center gap-1 border border-gray-200 dark:border-gray-600">
                                    <i class="fas fa-edit text-xs"></i> Edit
                                </button>
                                <button onclick="deleteStudentPrompt('${student.id}')" class="px-2 py-1 bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md text-xs flex items-center gap-1 border border-gray-200 dark:border-gray-600">
                                    <i class="fas fa-trash text-xs"></i> Delete
                                </button>
                                <a href="tel:${student.phone}" class="px-2 py-1 bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md text-xs flex items-center gap-1 border border-gray-200 dark:border-gray-600">
                                    <i class="fas fa-phone text-xs"></i> Call
                                </a>
                            </div>
                        </div>
                    `;

                    studentList.appendChild(card);
                });

                const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                showingCount.textContent = paginatedStudents.length;
                totalCount.textContent = filteredStudents.length;

                prevPage.disabled = currentPage === 1;
                nextPage.disabled = currentPage === totalPages || totalPages === 0;
            };

            const updateDashboard = () => {
                dashboardElements.total.textContent = filteredStudents.length;
                dashboardElements.called.textContent = filteredStudents.filter(s => s.status === 'Called').length;
                dashboardElements.followup.textContent = filteredStudents.filter(s => s.status === 'Follow-Up Needed').length;
                dashboardElements.agreed.textContent = filteredStudents.filter(s => s.status === 'Agreed').length;
                dashboardElements.none.textContent = filteredStudents.filter(s => s.status === 'Not Interested').length;
                dashboardElements.NeedPhoneNumber.textContent = filteredStudents.filter(s => s.status === 'Need Phone-Number').length;
                dashboardElements.paid.textContent = filteredStudents.filter(s => s.status === 'Paid').length;
            };

            const initCharts = () => {
                // Class distribution chart (by institution)
                const classCtx = document.getElementById('classChart').getContext('2d');
                classChart = new Chart(classCtx, {
                    type: 'bar',
                    data: {
                        labels: [
                            "‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶¶‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶ì‡ßü‡¶æ‡¶π‡ßá‡¶¶‡ßÅ‡¶®‡ßç‡¶®‡ßá‡¶∏‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶Æ‡¶æ‡¶∞‡ßÅ‡¶´ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶Æ‡¶ø‡¶†‡¶æ‡¶®‡¶æ‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶¶‡ßÇ‡¶∞‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶¨‡¶æ‡¶Æ‡¶® ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶∏‡ßÅ‡¶´‡¶ø‡ßü‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶Æ‡¶æ‡¶ú‡¶π‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                            "‡¶Æ‡¶æ‡¶¶‡¶¨‡¶æ‡¶∞‡¶π‡¶æ‡¶ü ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ",
                            "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ",
                            "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶¨‡¶æ‡¶á‡¶§‡ßÅ‡¶∂ ‡¶∂‡¶∞‡¶´ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ"
                        ],
                        datasets: [{
                            label: 'Students by Institution',
                            backgroundColor: '#3b82f6',
                            borderColor: '#2563eb',
                            borderWidth: 1,
                            data: new Array(13).fill(0) // Initialize with zeros for all institutions
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                ticks: {
                                    autoSkip: false,
                                    callback: function(value, index, ticks) {
                                        // Show short name on mobile, full name on desktop
                                        const label = this.getLabelForValue(value);
                                        if (window.innerWidth < 640) {
                                            // Use initials or short form for mobile
                                            const shortNames = [
                                                "‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶¶‡¶∞‡¶¨‡¶æ‡¶∞",
                                                "‡¶ì‡ßü‡¶æ‡¶π‡ßá‡¶¶‡ßÅ‡¶®‡ßç‡¶®‡ßá‡¶∏‡¶æ",
                                                "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ",
                                                "‡¶Æ‡¶æ‡¶∞‡ßÅ‡¶´ ‡¶Æ‡¶°‡ßá‡¶≤",
                                                "‡¶Æ‡¶ø‡¶†‡¶æ‡¶®‡¶æ‡¶≤‡¶æ",
                                                "‡¶¶‡ßÇ‡¶∞‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞",
                                                "‡¶¨‡¶æ‡¶Æ‡¶® ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞",
                                                "‡¶∏‡ßÅ‡¶´‡¶ø‡ßü‡¶æ",
                                                "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤",
                                                "‡¶Æ‡¶æ‡¶ú‡¶π‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï",
                                                "‡¶Æ‡¶æ‡¶¶‡¶¨‡¶æ‡¶∞‡¶π‡¶æ‡¶ü",
                                                "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤",
                                                "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶¨‡¶æ‡¶á‡¶§‡ßÅ‡¶∂"
                                            ];
                                            return shortNames[index] || label;
                                        }
                                        return label;
                                    },
                                    maxRotation: window.innerWidth < 640 ? 30 : 45,
                                    minRotation: window.innerWidth < 640 ? 30 : 45,
                                    font: function(context) {
                                        // Smaller font on mobile
                                        return {
                                            size: window.innerWidth < 640 ? 9 : 12,
                                            weight: 'bold'
                                        };
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.parsed.y} students`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Status distribution chart
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Not Checked', 'Called', 'Follow-Up Needed', 'Agreed', 'Paid', 'Not Interested', 'Need Phone-Number'],
                        datasets: [{
                            data: new Array(7).fill(0), // Initialize with zeros for all statuses
                            backgroundColor: [
                                '#9ca3af', // Not Checked
                                '#a855f7', // Called
                                '#eab308', // Follow-Up Needed
                                '#3b82f6', // Agreed
                                '#10b981', // Paid
                                '#ef4444', // Not Interested
                                '#4d4d4d'  // Need Phone-Number
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '65%'
                    }
                });

                // Class grade distribution chart (6-12)
                const classGradeCtx = document.getElementById('classGradeChart').getContext('2d');
                classGradeChart = new Chart(classGradeCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Class 6', 'Class 7', 'Class 8', 'Class 9', 'Class 10', 'Class 11', 'Class 12'],
                        datasets: [{
                            label: 'Students by Class',
                            data: new Array(7).fill(0), // Initialize with zeros for all classes
                            backgroundColor: [
                                '#3b82f6', // Class 6
                                '#10b981', // Class 7
                                '#f59e0b', // Class 8
                                '#ef4444', // Class 9
                                '#8b5cf6', // Class 10
                                '#ec4899', // Class 11
                                '#14b8a6'  // Class 12
                            ],
                            borderColor: [
                                '#2563eb',
                                '#059669',
                                '#d97706',
                                '#dc2626',
                                '#7c3aed',
                                '#db2777',
                                '#0d9488'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.parsed.y} students`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Progress chart (timeline)
                const progressCtx = document.getElementById('progressChart').getContext('2d');
                progressChart = new Chart(progressCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Admissions Progress',
                            data: [],
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            tension: 0.1,
                            pointBackgroundColor: '#3b82f6',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.parsed.y} total students`;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const updateCharts = () => {
                // Only update if charts exist
                if (!classChart || !statusChart || !classGradeChart || !progressChart) return;

                // Update class chart (by institution)
                const institutionMap = {
                    "bishwo-dorbar-school": "‡¶¨‡¶ø‡¶∂‡ßç‡¶¨ ‡¶¶‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "wahedunnesa-school": "‡¶ì‡ßü‡¶æ‡¶π‡ßá‡¶¶‡ßÅ‡¶®‡ßç‡¶®‡ßá‡¶∏‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "mithachora-high-school": "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "maruf-model-school": "‡¶Æ‡¶æ‡¶∞‡ßÅ‡¶´ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "mithanala-high-school": "‡¶Æ‡¶ø‡¶†‡¶æ‡¶®‡¶æ‡¶≤‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "durgapur-high-school": "‡¶¶‡ßÇ‡¶∞‡ßç‡¶ó‡¶æ‡¶™‡ßÅ‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "bamon-sundor-school": "‡¶¨‡¶æ‡¶Æ‡¶® ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "sufia-high-school": "‡¶∏‡ßÅ‡¶´‡¶ø‡ßü‡¶æ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "jhulanpol-high-school": "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "majharul-haque-school": "‡¶Æ‡¶æ‡¶ú‡¶π‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶π‡¶ï ‡¶â‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ‡¶≤‡ßü",
                    "madbarhat-fazil-madrasa": "‡¶Æ‡¶æ‡¶¶‡¶¨‡¶æ‡¶∞‡¶π‡¶æ‡¶ü ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ",
                    "mithachora-fazil-madrasa": "‡¶Æ‡¶ø‡¶†‡¶æ‡¶õ‡ßú‡¶æ ‡¶á‡¶É ‡¶´‡¶æ‡¶ú‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ",
                    "jhulanpol-baitus-sharaf": "‡¶ù‡ßÅ‡¶≤‡¶®‡¶™‡ßã‡¶≤ ‡¶¨‡¶æ‡¶á‡¶§‡ßÅ‡¶∂ ‡¶∂‡¶∞‡¶´ ‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ"
                };
                const institutionKeys = [
                    "bishwo-dorbar-school",
                    "wahedunnesa-school",
                    "mithachora-high-school",
                    "maruf-model-school",
                    "mithanala-high-school",
                    "durgapur-high-school",
                    "bamon-sundor-school",
                    "sufia-high-school",
                    "jhulanpol-high-school",
                    "majharul-haque-school",
                    "madbarhat-fazil-madrasa",
                    "mithachora-fazil-madrasa",
                    "jhulanpol-baitus-sharaf"
                ];
                const institutionCounts = institutionKeys.map(inst =>
                    filteredStudents.filter(s => s.class === inst).length
                );
                classChart.data.datasets[0].data = institutionCounts;
                classChart.update();

                // Update status chart
                const statusCounts = [
                    filteredStudents.filter(s => s.status === 'Not Checked').length,
                    filteredStudents.filter(s => s.status === 'Called').length,
                    filteredStudents.filter(s => s.status === 'Follow-Up Needed').length,
                    filteredStudents.filter(s => s.status === 'Agreed').length,
                    filteredStudents.filter(s => s.status === 'Paid').length,
                    filteredStudents.filter(s => s.status === 'Not Interested').length,
                    filteredStudents.filter(s => s.status === 'Need Phone-Number').length
                ];
                statusChart.data.datasets[0].data = statusCounts;
                statusChart.update();

                // Update class grade chart (6-12)
                const classGrades = ['6', '7', '8', '9', '10', '11', '12'];
                const classGradeCounts = classGrades.map(grade =>
                    filteredStudents.filter(s => s.classGrade === grade).length
                );
                classGradeChart.data.datasets[0].data = classGradeCounts;
                classGradeChart.update();

                // Update progress chart (timeline)
                if (filteredStudents.length > 0) {
                    const dateMap = {};
                    filteredStudents.forEach(student => {
                        const date = student.date.split('T')[0];
                        dateMap[date] = (dateMap[date] || 0) + 1;
                    });

                    const sortedDates = Object.keys(dateMap).sort();
                    const cumulativeCounts = [];
                    let total = 0;

                    sortedDates.forEach(date => {
                        total += dateMap[date];
                        cumulativeCounts.push(total);
                    });

                    progressChart.data.labels = sortedDates.map(date => formatDate(date));
                    progressChart.data.datasets[0].data = cumulativeCounts;
                } else {
                    progressChart.data.labels = [];
                    progressChart.data.datasets[0].data = [];
                }
                progressChart.update();
            };

            // ================ EVENT LISTENERS ================
            openStudentPanel.addEventListener('click', () => {
                currentEditingId = null;
                modalTitle.textContent = 'Add Student';
                studentForm.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('classGrade').value = '6'; // Default to Class 6
                studentPanelModal.classList.remove('hidden');
            });

            closeStudentPanel.addEventListener('click', () => {
                studentPanelModal.classList.add('hidden');
            });

            studentForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const studentData = {
                    name: document.getElementById('name').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    class: document.getElementById('class').value,
                    classGrade: document.getElementById('classGrade').value,
                    group: document.getElementById('group').value,
                    date: document.getElementById('date').value,
                    status: document.getElementById('status').value,
                    info: document.getElementById('info').value.trim()
                };

                const success = await saveStudent(studentData, currentEditingId);
                if (success) {
                    studentPanelModal.classList.add('hidden');
                }
            });

            // Debounced search and filter handlers
            searchInput.addEventListener('input', debounce(filterStudents, 300));
            statusFilter.addEventListener('change', filterStudents);
            classFilter.addEventListener('change', filterStudents);
            groupFilter.addEventListener('change', filterStudents);
            classGradeFilter.addEventListener('change', filterStudents);
            startDateFilter.addEventListener('change', filterStudents);
            endDateFilter.addEventListener('change', filterStudents);
            resetFilters.addEventListener('click', resetAllFilters);

            // Pagination handlers
            prevPage.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderStudents();
                }
            });

            nextPage.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderStudents();
                }
            });

            // Confirmation modal handlers
            cancelConfirm.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                pendingAction = null;
                pendingActionData = null;
            });

            proceedConfirm.addEventListener('click', async () => {
                confirmModal.classList.add('hidden');

                if (pendingAction === 'deleteStudent') {
                    await deleteStudent(pendingActionData);
                } else if (pendingAction === 'importCSV') {
                    await performCSVImport(pendingActionData);
                } else if (pendingAction === 'restoreData') {
                    await performRestore(pendingActionData);
                }

                pendingAction = null;
                pendingActionData = null;
            });

            // Data export/import handlers
            exportCSV.addEventListener('click', exportToCSV);
            exportPDF.addEventListener('click', exportToPDF);
            backupJSON.addEventListener('click', backupToJSON);

            importCSV.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importFromCSV(e.target.files[0]);
                }
            });

            restoreJSON.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    restoreFromJSON(e.target.files[0]);
                }
            });

            // Dark mode toggle handler
            darkModeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);

                if (isDark) {
                    toggleThumb.classList.add('translate-x-8');
                    toggleThumb.classList.remove('translate-x-0');
                    toggleIcon.textContent = '‚òÄÔ∏è';
                } else {
                    toggleThumb.classList.add('translate-x-0');
                    toggleThumb.classList.remove('translate-x-8');
                    toggleIcon.textContent = 'üåô';
                }

                // Reinitialize charts when theme changes
                initCharts();
                updateCharts();
            });

            // Initialize dark mode from localStorage
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                toggleThumb.classList.add('translate-x-8');
                toggleIcon.textContent = '‚òÄÔ∏è';
            } else {
                toggleThumb.classList.add('translate-x-0');
                toggleIcon.textContent = 'üåô';
            }

            // Initialize the application
            initCharts();
            fetchStudents();

            // Set up Supabase realtime subscription
            const channel = supabaseMain
                .channel('students_changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'students' },
                    (payload) => {
                        fetchStudents();
                    }
                )
                .subscribe();

            // Expose functions to global scope for button onclick handlers
            window.editStudent = (id) => {
                const student = students.find(s => s.id === id);
                if (!student) return;

                currentEditingId = id;
                modalTitle.textContent = 'Edit Student';

                document.getElementById('name').value = student.name;
                document.getElementById('phone').value = student.phone;
                document.getElementById('class').value = student.class;
                document.getElementById('classGrade').value = student.classGrade;
                document.getElementById('group').value = student.group;
                document.getElementById('date').value = student.date;
                document.getElementById('status').value = student.status;
                document.getElementById('info').value = student.info || '';

                studentPanelModal.classList.remove('hidden');
            };

            window.deleteStudentPrompt = (id) => {
                const student = students.find(s => s.id === id);
                if (!student) return;

                showConfirmation(
                    'Delete Student',
                    `Are you sure you want to delete ${student.name}? This action cannot be undone.`,
                    'deleteStudent',
                    id
                );
            };
        });
    </script>



</body>

</html>